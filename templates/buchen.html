<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Tennisplatz buchen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header>
    <a href="{{ url_for('index') }}">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
    </a>
    <h1>Tennisplatz-Buchungssystem</h1>
</header>

<form method="POST" action="{{ url_for('buchen') }}" id="buchungsform">
    <div class="container">
        
        {% if fehler %}
        <div class="error">{{ fehler }}</div>
        {% endif %}
        
        <div id="js-fehler" class="error" style="display:none;"></div>

        <div class="form-section">
            <h2>Personalien</h2>
            
            <div class="form-group">
                <label>Nutzer-ID</label>
                <input type="number" name="nid" id="nid" placeholder="Bestehende Nutzer-ID eingeben" value="{{ form_data.nid if form_data else (nutzer.nid if nutzer else '') }}">
                <small>Falls vorhanden, geben Sie zusätzlich Ihre E-Mail zur Verifizierung ein.</small>
            </div>

            <div class="form-group">
                <label>Vorname *</label>
                <input type="text" name="vorname" id="vorname" value="{{ form_data.vorname if form_data else (nutzer.vorname if nutzer else '') }}" required>
            </div>

            <div class="form-group">
                <label>Nachname *</label>
                <input type="text" name="nachname" id="nachname" value="{{ form_data.nachname if form_data else (nutzer.nachname if nutzer else '') }}" required>
            </div>

            <div class="form-group">
                <label>Geburtsdatum</label>
                <input type="date" name="geburtsdatum" id="geburtsdatum" value="{{ form_data.geburtsdatum if form_data else (nutzer.geburtsdatum if nutzer else '') }}">
            </div>

            <div class="form-group">
                <label>E-Mail *</label>
                <input type="email" name="email" id="email" value="{{ form_data.email if form_data else (nutzer.email if nutzer else '') }}" required>
            </div>
        </div>

        <div class="form-section">
            <h2>Buchungsdetails</h2>

            <div class="form-group">
                <label>Tennisanlage *</label>
                <select name="tennisanlage" id="tennisanlage" required>
                    <option value="">-- bitte wählen --</option>
                    {% for anlage in anlagen %}
                        <option value="{{ anlage }}" {% if form_data and form_data.tennisanlage == anlage %}selected{% endif %}>{{ anlage }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Platznummer *</label>
                <select name="platznummer" id="platznummer" required>
                    <option value="">-- zuerst Tennisanlage wählen --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Spieldatum *</label>
                <input type="date" name="spieldatum" id="spieldatum" value="{{ form_data.spieldatum if form_data else '' }}" required>
            </div>

            <div class="form-group">
                <label>Spielbeginn *</label>
                <input type="time" name="beginn" id="beginn" value="{{ form_data.beginn if form_data else '' }}" min="07:00" max="20:00" step="1800" required>
            </div>

            <div class="form-group">
                <label>Spielende *</label>
                <input type="time" name="ende" id="ende" value="{{ form_data.ende if form_data else '' }}" min="07:00" max="20:00" step="1800" required>
            </div>

            <button type="submit">Buchung bestätigen</button>
        </div>

    </div>
</form>

<footer>
    <p>
        <strong>Impressum</strong><br>
        Tennisverein Musterstadt · Musterstraße 1 · 12345 Musterstadt
    </p>
</footer>

<script>
const allePlaetze = {{ alle_plaetze | tojson | safe }};

function isValidTime(timeString) {
    const parts = timeString.split(':');
    if (parts.length < 2) return false;
    const minutes = parseInt(parts[1]);
    return minutes === 0 || minutes === 30;
}

function showError(message) {
    const errorDiv = document.getElementById('js-fehler');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideError() {
    const errorDiv = document.getElementById('js-fehler');
    errorDiv.style.display = 'none';
}

function checkNidAndEmail() {
    let nid = document.getElementById("nid").value;
    let email = document.getElementById("email").value;
    
    if (!nid && !email) {
        hideError();
        document.getElementById("vorname").value = "";
        document.getElementById("nachname").value = "";
        document.getElementById("geburtsdatum").value = "";
        return;
    }
    
    if (nid && !email) {
        showError('Bitte geben Sie auch Ihre E-Mail-Adresse zur Verifizierung ein.');
        return;
    }
    
    if (!nid && email) {
        hideError();
        return;
    }
    
    if (nid && email) {
        fetch(`/get_nutzer/${nid}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists === false || !data.vorname) {
                showError('Diese Nutzer-ID existiert nicht in der Datenbank.');
                document.getElementById("nid").value = "";
                document.getElementById("vorname").value = "";
                document.getElementById("nachname").value = "";
                document.getElementById("geburtsdatum").value = "";
            } else if (data.email !== email) {
                showError('Die E-Mail-Adresse stimmt nicht mit der Nutzer-ID überein.');
                document.getElementById("nid").value = "";
                document.getElementById("vorname").value = "";
                document.getElementById("nachname").value = "";
                document.getElementById("geburtsdatum").value = "";
            } else {
                hideError();
                document.getElementById("vorname").value = data.vorname || "";
                document.getElementById("nachname").value = data.nachname || "";
                document.getElementById("geburtsdatum").value = data.geburtsdatum || "";
            }
        })
        .catch(error => {
            console.error("Fehler:", error);
            showError("Fehler beim Abrufen der Nutzerdaten");
        });
    }
}

function updatePlatznummern() {
    const gewaehlteAnlage = document.getElementById("tennisanlage").value;
    const platznummerSelect = document.getElementById("platznummer");
    
    platznummerSelect.innerHTML = '<option value="">-- bitte wählen --</option>';
    
    if (!gewaehlteAnlage) return;
    
    const verfuegbarePlaetze = allePlaetze.filter(p => p.tennisanlage === gewaehlteAnlage);
    
    verfuegbarePlaetze.forEach(platz => {
        const option = document.createElement("option");
        option.value = platz.platznummer;
        option.textContent = `Platz ${platz.platznummer} (${platz.belag})`;
        platznummerSelect.appendChild(option);
    });
}

document.addEventListener("DOMContentLoaded", function() {
    const heute = new Date().toISOString().split('T')[0];
    document.getElementById("spieldatum").setAttribute("min", heute);
    
    document.getElementById("nid").addEventListener("blur", checkNidAndEmail);
    document.getElementById("email").addEventListener("blur", checkNidAndEmail);
    
    document.getElementById("tennisanlage").addEventListener("change", updatePlatznummern);
    
    const tennisanlageSelect = document.getElementById("tennisanlage");
    const gespeichertePlatznummer = "{{ form_data.platznummer if form_data else '' }}";
    
    if (tennisanlageSelect.value) {
        updatePlatznummern();
        if (gespeichertePlatznummer) {
            setTimeout(() => {
                document.getElementById("platznummer").value = gespeichertePlatznummer;
            }, 100);
        }
    }
    
    const form = document.getElementById('buchungsform');
    form.addEventListener('submit', function(e) {
        hideError();
        
        const beginn = document.getElementById('beginn').value;
        const ende = document.getElementById('ende').value;
        
        if (beginn && !isValidTime(beginn)) {
            e.preventDefault();
            showError('Die Zeitangabe für Spielbeginn muss auf :00 oder :30 enden. Bitte korrigieren Sie Ihre Eingabe.');
            document.getElementById('beginn').value = '';
            document.getElementById('beginn').focus();
            return false;
        }
        
        if (ende && !isValidTime(ende)) {
            e.preventDefault();
            showError('Die Zeitangabe für Spielende muss auf :00 oder :30 enden. Bitte korrigieren Sie Ihre Eingabe.');
            document.getElementById('ende').value = '';
            document.getElementById('ende').focus();
            return false;
        }
    });
});
</script>

</body>
</html>