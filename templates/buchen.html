<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <title>{{ _("Tennisplatz buchen") }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

<h1>{{ _("Tennisplatz‑Buchungssystem") }}</h1>

<form method="POST" action="{{ url_for('buchen') }}" id="buchungsform">

    {% if fehler %}
        <p class="error">{{ fehler }}</p>
    {% endif %}

    <div id="js-fehler" class="error"></div>

    <h2>{{ _("Buchen") }}</h2>

    <h3>{{ _("Personalien") }}</h3>

    <label>{{ _("Nutzer-ID (optional, nur bestehende IDs)") }}</label>
    <input type="number" name="nid" id="nid">

    <label>{{ _("Vorname") }} *</label>
    <input type="text" name="vorname" id="vorname" required>

    <label>{{ _("Nachname") }} *</label>
    <input type="text" name="nachname" id="nachname" required>

    <label>{{ _("Geburtsdatum") }}</label>
    <input type="date" name="geburtsdatum" id="geburtsdatum">

    <label>{{ _("E-Mail") }} *</label>
    <input type="email" name="email" id="email" required>

    <h3>{{ _("Buchungsdetails") }}</h3>

    <label>{{ _("Tennisanlage") }} *</label>
    <select name="tennisanlage" id="tennisanlage" required>
        <option value="">{{ _("-- bitte wählen --") }}</option>
        {% for anlage in alle_plaetze | map(attribute='tennisanlage') | unique %}
            <option value="{{ anlage }}">{{ anlage }}</option>
        {% endfor %}
    </select>

    <label>{{ _("Platznummer") }} *</label>
    <select name="platznummer" id="platznummer" required>
        <option value="">{{ _("-- zuerst Tennisanlage wählen --") }}</option>
    </select>

    <label>{{ _("Spieldatum") }} *</label>
    <input type="date" name="spieldatum" id="spieldatum" required>

    <label>{{ _("Spielbeginn") }} *</label>
    <input type="time" name="beginn" id="beginn" min="07:00" max="20:00" required>

    <label>{{ _("Spielende") }} *</label>
    <input type="time" name="ende" id="ende" min="07:00" max="20:00" required>

    <button type="submit">{{ _("Buchung bestätigen") }}</button>
</form>


<!-- Übersetzbare JS-Texte -->
<script>
    const msgBeginnFehler = "{{ _('Spielbeginn muss auf :00 oder :30 enden.') }}";
    const msgEndeFehler = "{{ _('Spielende muss auf :00 oder :30 enden.') }}";
    const msgEmailFehlt = "{{ _('Bitte geben Sie auch Ihre E-Mail-Adresse zur Verifizierung ein.') }}";
    const msgNutzerExistiertNicht = "{{ _('Diese Nutzer-ID existiert nicht in der Datenbank.') }}";
    const msgEmailMismatch = "{{ _('Die E-Mail-Adresse stimmt nicht mit der Nutzer-ID überein.') }}";

    const allePlaetze = {{ alle_plaetze | tojson | safe }};
</script>


<script>
// Datum min = heute
document.addEventListener("DOMContentLoaded", function() {
    const heute = new Date().toISOString().split('T')[0];
    document.getElementById("spieldatum").setAttribute("min", heute);
});


// Nutzer-ID + Email prüfen
function checkNidAndEmail() {
    let nid = document.getElementById("nid").value;
    let email = document.getElementById("email").value;
    const jsFehlerDiv = document.getElementById('js-fehler');

    if (!nid && !email) return;

    if (nid && !email) {
        jsFehlerDiv.textContent = msgEmailFehlt;
        return;
    }

    if (nid && email) {
        fetch(`/get_nutzer/${nid}`)
        .then(r => r.json())
        .then(data => {
            if (!data.exists) {
                jsFehlerDiv.textContent = msgNutzerExistiertNicht;
                return;
            }
            if (data.email !== email) {
                jsFehlerDiv.textContent = msgEmailMismatch;
                return;
            }

            document.getElementById("vorname").value = data.vorname;
            document.getElementById("nachname").value = data.nachname;
            document.getElementById("geburtsdatum").value = data.geburtsdatum;
        });
    }
}

document.getElementById("nid").addEventListener("blur", checkNidAndEmail);
document.getElementById("email").addEventListener("blur", checkNidAndEmail);


// Plätze nach Anlage filtern
document.getElementById("tennisanlage").addEventListener("change", function() {
    const anlage = this.value;
    const select = document.getElementById("platznummer");

    select.innerHTML = `<option value="">${"-- bitte wählen --"}</option>`;

    allePlaetze
        .filter(p => p.tennisanlage === anlage)
        .forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.platznummer;
            opt.textContent = `Platz ${p.platznummer} (${p.belag})`;
            select.appendChild(opt);
        });
});


// Zeitvalidierung
document.getElementById("buchungsform").addEventListener("submit", function(e) {
    const jsFehlerDiv = document.getElementById('js-fehler');

    const beginn = document.getElementById('beginn').value;
    const ende = document.getElementById('ende').value;

    if (beginn && !["00","30"].includes(beginn.split(":")[1])) {
        e.preventDefault();
        jsFehlerDiv.textContent = msgBeginnFehler;
        return;
    }

    if (ende && !["00","30"].includes(ende.split(":")[1])) {
        e.preventDefault();
        jsFehlerDiv.textContent = msgEndeFehler;
        return;
    }
});
</script>

</body>
</html>